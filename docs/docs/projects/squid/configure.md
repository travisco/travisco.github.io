---
layout: default
title: Configure Proxy
description: "Squid Proxy configuration to use as a proxy."
parent: Squid Proxy
grand_parent: Projects
nav_order: 99
---

# Squid - Configure squid as proxy
{: .no_toc }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

### Proxy configuration on RHEL / CentOS / Fedora

List of Squid Proxies

| Region           | Hostname             | IP Address           |
|:-----------------|:---------------------|:---------------------|
| US South         | ossproxylbdal1001    | 172.11.22.33:3128    |
| US East          | ossproxylbsjc0301    | 173.22.33.44:3128    |
| US Cross Region  | ossproxylbwdc0401    | 174.33.44.55:3128    |


### Requesting Service Accounts for Egress Proxy Authentication


For any new services that require authenticated proxy connectivity outside IBM Networks, a request for a service account belonging to the cos_egress_proxy AD group will need to be submitted using the process outlined in this document.

How to Request Service Accounts from Fabric: [Service Account Request](https://confluence.softlayer.local/x/SZPI){: .btn .btn-black } 

How to Open a Fabric Request:  [Fabric Request](https://confluence.softlayer.local/x/R5S1 ){: .btn .btn-blue }


For Egress Proxy service accounts, populate the request using the method in the above articles as documented below: 

**Type**: Task
**Components**: Fabric - Windows, Operations
**IMS Environment**: Commercial or FED
**Service Account Name(s)**: (please adjust to any approved format, these are merely suggestions)

cosuategress
cosdpegress
cosmapiegress
cosprovegress
coscicdegres

**Purpose**: Accounts Needed for FS Cloud Egress Proxy Authentication.
**Manager Approval**: Robert Cabrera / Florin Herescu
**Email Distribution list for notifications, in RFC Standard format**: ibm_cos_datapath@wwpdl.vnet.ibm.com
**Department**: IBM COS

### Service Testing and Validation

<div>
**Abstract**:

To have better security check points for traffic moving over our networks, the forward proxy has been designed to authenticate traffic flows, at which will be targeting external services, and are traveling over the public network.

This document serves as a guide to assist in the testing and validation of essential operational egress traffic flows.  This document is a work in progress, and will be developed based on the testing methodology and results generated by each COS Squad and their respective traffic flows.  

</div>

#### Overview:

Our financial services cloud implementation is required to meet strict security controls for our customers.Those controls are specified for all aspects of handling customer data from data at rest policies to data in flight policies.This feature addresses the need to meet the egress control SC-7-8(Session Authentication)for communication from the dsNet system to external services such as IAM, Key Protect and HPCS. Specific SOC criteria is:

“The information system protects the authenticity of communications sessions.”

This feature improves network protection by forcing network entities to prove they are allowed to use a defined route in the network, rather just trying to limit traffic to a known address space. This mitigates attacks such as an advisory trying to use the route as a stepping stone path to attack other services and spread laterally through the network.

It also helps prevent data exfiltrate through the route as the attacker must know both the credential and the protocol for the path. In addition to the cited SOC criteria, IBM guidance states that egress controls from IBM services to other IBM services or external entities should be done through an authenticated proxy.



##### TESTING CRITERIA:

A service is required to authenticate through the authenticated proxy if it meets the following conditions. 

- The service is required by IBM Cloud Object Storage functionality.  This includes but is not limited to billing, provisioning, monitoring, logging, reporting, etc. 
- The Path to the service requires egress from an IBM Internal Network to the Public Internet for functional connectivity. 


##### TESTING ID:

The UAT testing ID can be found in Thycotic HERE.  If you do not have access to view this, please inform a member of the STORLB Squad to determine if your ID can be added for access.  If it cannot, a member of your team with access will need to provide the credentials to you.  This ID should not be shared carelessly, at it does provide the ability to authenticate through the proxy to the internet. 

##### TESTING LOCATIONS:

**Type**: Explicit Proxy- WDC
**IP**: 172.23.197.176
**Port**: 443


**Type**: Explicit Proxy- MON
**IP**: 172.26.165.155
**Port**: 443

##### TESTING REQUIREMENTS:

-- Proxy Expects to see a proper RFC 7235 HTTP header in the GET request. Example:  Proxy-Authorization: Basic LcBGHn72rg92X5n8


-- Hashed information in header is "username:password" using the service credentials created for the proxy. 


-- Proxy will decode and parse/decode HTTP header containing credentials and authenticate + Validate user credentials, If successful, original packet is allowed through to destination. If the authentication fails, most likely a "401 Unauthorized" will come back.

#### Configuring proxy through the CLI


Verify no proxy is currently set, if one is please consult with the system administrators to confirm you wont break any connections. 

```bash
# echo $http_proxy
```


Once you have your user added to the AD groups, if not please get with your lead or [ARTICLE LINK], head over here to request access. This is for passwords without special characters. 

```bash
# export http_proxy=http://USERNAME:PASSWORD@[IPADDRESSPROXY]:3128/
```


If your password has special characters, literal backslash characters (\) need to be doubled escape them as shown below.

```bash
# export http_proxy=http://USERNAME\#01:PASSWORD@[IPADDRESSPROXY]:3128/
```


When the username or password uses the @ symbol, add a backslash (\) before the @ – for example:

```bash
# export http_proxy=http:\\USERN\@ME:PASSWORD@[IPADDRESSPROXY]:3128
```


#### Configuring Proxy permanently (for processes without shell)


We will add a shell script file under /etc/profile. This will ensure the settings apply to all logged-in users.

```bash
sudo vi /etc/profile
```


Add your proxy settings.

```bash
# set proxy config via profie.d - should apply for all users
# 
PROXY_URL="http://USERNAME:PASSWORD@[IPADDRESSPROXY]:3128/"

export http_proxy="$PROXY_URL"
export https_proxy="$PROXY_URL"
export ftp_proxy="$PROXY_URL"
export no_proxy="127.0.0.1,localhost"

# For curl
export HTTP_PROXY="$PROXY_URL"
export HTTPS_PROXY="$PROXY_URL"
export FTP_PROXY="$PROXY_URL"
export NO_PROXY="127.0.0.1,localhost"
```


Source the file when done to start using the proxy settings, or alternatively logout and back in.

```bash
$ source /etc/profile
```


Confirm via

```bash
$ env | grep -i proxy
```



#### Set proxy for YUM|DNF package manager


The above settings will work for Applications and command-line tools but not for YUM and DNF package management tools.

```bash
$ sudo vim /etc/dnf/dnf.conf
# Add
proxy=http://USERNAME:PASSWORD@[IPADDRESSPROXY]:3128/

```



#### For CentOS 6/7:

You will set the username and password in the rhsm.conf file, but just enter the IP address and port of the proxy server here. 

```bash
$ sudo vim /etc/yum.conf
proxy=http://[IPADDRESSPROXY]:3128/
```

For RHEL users, you’ll also need to set Proxy for accessing RHSM content:

```bash
$ sudo vi /etc/rhsm/rhsm.conf
# Configure
proxy_hostname = proxy.example.com
proxy_port = 8080
```

If your proxy server requires authentication, also set

```bash
# user name for authenticating to an http proxy, if needed
proxy_username=

# password for basic http proxy auth, if needed
proxy_password =
```



### Ubuntu / Debian

#### Set System-Wide Proxy settings on CLI Solution 1


We will add a shell script file under /etc/profile.d/proxy.sh. This will ensure the settings apply to all logged-in users.


```bash
sudo nano  /etc/profile.d/proxy.sh
```

Populate your proxy values.

```bash
# set proxy config via profie.d - should apply for all users
# 
export http_proxy="http://[IPADDRESSPROXY]:3128/"
export https_proxy="http://[IPADDRESSPROXY]:3128/"
export ftp_proxy="http://[IPADDRESSPROXY]:3128/"
export no_proxy="127.0.0.1,localhost"

# For curl
export HTTP_PROXY="http://[IPADDRESSPROXY]:3128/"
export HTTPS_PROXY="http://[IPADDRESSPROXY]:3128/"
export FTP_PROXY="http://[IPADDRESSPROXY]:3128/"
export NO_PROXY="127.0.0.1,localhost"
```


Add other IPs you want to exclude from proxy to NO_PROXY & no_proxy environment variable.

Make it executable.

```bash
sudo chmod +x  /etc/profile.d/proxy.sh
```


Source the file to start using the proxy settings, or alternatively logout and back in.

```bash
$ source /etc/profile.d/proxy.sh
```

Confirm:

```bash
$ env | grep -i proxy
```

4
#### Set System-Wide Proxy settings on CLI Solution 2


To set the proxy environment variables to apply to all the system users or persistent across all shells, you can append these lines to /etc/environment.

```bash
echo -e "http_proxy=http://[IPADDRESSPROXY]:3128/\nhttps_proxy=https://[IPADDRESSPROXY]:3128/" | sudo tee -a /etc/environment
```

Note that these settings will only take effect on login again since the /etc/environment is read on system login. However, you can still use netplan command to apply the settings.

```bash
sudo netplan apply
```


To test this out, try to download anything from the terminal or run the system update. You will see that the connections is happening through the proxy server.

```bash
wget google.com
--2019-03-23 12:34:05--  http://google.com/
Connecting to [IPADDRESSPROXY]:3128...
```

